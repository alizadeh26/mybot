name: VPN Healthcheck

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *"  # every 2 hours

permissions:
  contents: write

concurrency:
  group: vpn-healthcheck
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_run_once.txt

      - name: Install sing-box
        env:
          SINGBOX_VERSION: "1.12.19"
        run: |
          set -e
          ASSET="sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
          URL="https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/${ASSET}"
          echo "Downloading $URL"
          curl -L "$URL" -o "$ASSET"
          tar -xzf "$ASSET"
          chmod +x "sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box"
          echo "SINGBOX_PATH=$GITHUB_WORKSPACE/sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box" >> $GITHUB_ENV

      - name: Run check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          SUBSCRIPTIONS_FILE: "subscriptions.txt"
          CLASH_API_HOST: "127.0.0.1"
          CLASH_API_PORT: "9090"
          REFRESH_HOURS: "2"
          TEST_URL: "https://cp.cloudflare.com/generate_204"
          TEST_TIMEOUT_MS: "6000"
          MAX_CONCURRENCY: "20"
          GITHUB_OUTPUT_TXT_PATH: "healthy.txt"
          GITHUB_OUTPUT_YAML_PATH: "healthy_clash.yaml"
          CHECK_HOST_COUNTRY: "ir"
          CHECK_HOST_MAX_ENDPOINTS: "50"
          CHECK_HOST_CONCURRENCY: "5"
          CHECK_HOST_POLL_WAIT_SECONDS: "15"
          GITHUB_OUTPUT_IR_PATH: "iran_reachable.txt"
          SPEED_TEST_ENABLED: "1"
          SPEED_TEST_THRESHOLD_KIB_S: "500"
          SPEED_TEST_MAX_NODES: "10"
          SPEED_TEST_CONCURRENCY: "1"
          SPEED_TEST_DOWNLOAD_BYTES: "2000000"
          SPEED_TEST_UPLOAD_BYTES: "1000000"
          SPEED_TEST_TIMEOUT_SECONDS: "25"
          GITHUB_OUTPUT_FAST_PATH: "fast_500kbps.txt"
        run: |
          python run_once.py

      - name: Commit and push outputs
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add healthy.txt healthy_clash.yaml iran_reachable.txt fast_500kbps.txt
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update healthy subscription"
          git push
